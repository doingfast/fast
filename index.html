<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IDE - 메모 & 파이썬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* VS Code와 유사한 테마 및 폰트 설정 */
        body {
            font-family: 'Fira Code', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        /* contenteditable 영역의 기본 스타일 */
        .editor-area {
            caret-color: #d4d4d4;
            white-space: pre-wrap;
            word-wrap: break-word;
            outline: none;
            line-height: 1.5;
            tab-size: 4;
            -moz-tab-size: 4;
        }
        /* contenteditable placeholder */
        .editor-area:empty::before {
            content: attr(data-placeholder);
            color: #6a6a6a;
            pointer-events: none;
        }
        /* 스크롤바 스타일 */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Python Syntax Highlighting Classes */
        .token-keyword { color: #c586c0; }
        .token-function { color: #dcdcaa; }
        .token-string { color: #ce9178; }
        .token-number { color: #b5cea8; }
        .token-comment { color: #6a9955; }
        .token-operator { color: #d4d4d4; }
        .token-punctuation { color: #d4d4d4; }
        .token-default { color: #9cdcfe; }

        /* 활성 탭 스타일 */
        .tab.active {
            background-color: #3f3f46;
            border-bottom: 2px solid #007acc;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header / Tab area -->
    <header class="bg-[#252526] flex-shrink-0">
        <div class="flex items-center border-t border-t-[#3f3f46]">
            <button id="memo-tab" class="tab px-4 py-2 text-sm focus:outline-none">
                📝 memo.txt
            </button>
            <button id="python-tab" class="tab px-4 py-2 text-sm focus:outline-none">
                🐍 script.py
            </button>
            <button id="run-button" class="hidden ml-auto mr-4 px-3 py-1 text-sm bg-green-600 hover:bg-green-700 rounded focus:outline-none text-white">
                실행 ▶
            </button>
        </div>
    </header>

    <!-- Main Editor Area -->
    <main class="flex-grow bg-[#1e1e1e] p-4 overflow-auto">
        <div id="editor" 
             contenteditable="true" 
             spellcheck="false" 
             class="editor-area h-full w-full"
             data-placeholder="여기에 내용을 입력하세요...">
        </div>
    </main>

    <!-- Output Console -->
    <div id="output-console" class="hidden flex-shrink-0 border-t-2 border-[#007acc]">
        <div class="bg-[#252526] px-4 py-1 flex justify-between items-center text-sm">
            <span>출력</span>
            <button id="close-console-btn" class="text-xs hover:text-white text-gray-400">✖</button>
        </div>
        <pre id="output-text" class="p-4 text-sm whitespace-pre-wrap h-40 overflow-y-auto bg-[#1e1e1e]"></pre>
    </div>


    <!-- Footer / Status Bar -->
    <footer class="bg-[#007acc] text-white flex-shrink-0 px-4 py-1 text-sm flex justify-between items-center">
        <div>
            <span id="status-text">준비 완료</span>
        </div>
        <div>
            <span>Ln 1, Col 1</span> <!-- 이 부분은 기능 구현에서 제외되었습니다. -->
        </div>
    </footer>

    <script>
        // DOM 요소 가져오기
        const memoTab = document.getElementById('memo-tab');
        const pythonTab = document.getElementById('python-tab');
        const editor = document.getElementById('editor');
        const statusText = document.getElementById('status-text');
        const runButton = document.getElementById('run-button');
        const outputConsole = document.getElementById('output-console');
        const outputText = document.getElementById('output-text');
        const closeConsoleBtn = document.getElementById('close-console-btn');

        // 애플리케이션 상태
        let currentState = {
            mode: 'memo', // 'memo' or 'python'
            content: ''
        };
        
        // --- URL 처리 ---
        function updateURL() {
            try {
                const text = editor.innerText;
                const base64 = btoa(unescape(encodeURIComponent(text)));
                const hashContent = `mode=${currentState.mode}&data=${base64}`;
                if (window.location.hash !== '#' + hashContent) {
                   window.location.hash = hashContent;
                }
                currentState.content = text;
            } catch (e) {
                console.error("URL 업데이트 실패:", e);
                statusText.textContent = "오류: 내용을 URL에 저장할 수 없습니다.";
            }
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const mode = params.get('mode') || 'memo';
            const data = params.get('data');

            switchMode(mode, false);

            if (data) {
                try {
                    const decodedText = decodeURIComponent(escape(atob(data)));
                    editor.innerText = decodedText;
                    currentState.content = decodedText;
                    if(currentState.mode === 'python') {
                        highlightSyntax();
                        validatePythonCode();
                    }
                } catch (e) {
                    console.error("URL에서 데이터 로드 실패:", e);
                    editor.innerText = "URL에 저장된 데이터를 불러오는 데 실패했습니다.";
                }
            }
        }

        // --- 모드 전환 ---
        function switchMode(newMode, shouldUpdateURL = true) {
            currentState.mode = newMode;
            if (newMode === 'memo') {
                memoTab.classList.add('active');
                pythonTab.classList.remove('active');
                editor.dataset.placeholder = '간단한 메모를 작성하세요...';
                editor.innerHTML = editor.innerText;
                statusText.textContent = "메모 모드";
                runButton.classList.add('hidden');
                closeConsole();
            } else { // python mode
                pythonTab.classList.add('active');
                memoTab.classList.remove('active');
                editor.dataset.placeholder = 'Python 코드를 작성하세요...\n\n# 예시 코드\nprint("안녕하세요! Web IDE입니다.")\nfor i in range(5):\n    print(f"{i+1}번째 출력입니다.")';
                runButton.classList.remove('hidden');
                highlightSyntax();
                validatePythonCode();
            }
            if (shouldUpdateURL) {
                updateURL();
            }
        }

        // --- Python 코드 실행 ---
        function runPythonCode() {
            outputConsole.classList.remove('hidden');
            const code = editor.innerText;
            let capturedOutput = '';

            const originalConsoleLog = console.log;
            console.log = (...args) => {
                capturedOutput += args.join(' ') + '\n';
            };
            
            // Python의 print()를 JavaScript의 console.log()로 변환하여 실행을 시뮬레이션합니다.
            const jsCode = code.replace(/print\s*\((.*?)\)/g, 'console.log($1)');

            try {
                new Function(jsCode)();
                outputText.textContent = capturedOutput || '(출력 없음)';
            } catch (e) {
                outputText.textContent = `실행 오류:\n${e}`;
            } finally {
                console.log = originalConsoleLog; // 원래 console.log로 복원
            }
        }
        
        function closeConsole() {
            outputConsole.classList.add('hidden');
        }

        // --- Python 코드 하이라이팅 및 유효성 검사 ---
        const pythonPatterns = {
            keyword: /\b(def|return|if|else|elif|for|while|import|from|class|try|except|finally|with|as|and|or|not|in|is|lambda|pass|break|continue|global|nonlocal|yield|assert|del|True|False|None)\b/g,
            function: /\b([a-zA-Z_][a-zA-Z0-9_]*)(?=\s*\()/g,
            string: /('[^']*'|"[^"]*"|f'[^']*'|f"[^"]*")/g,
            number: /\b\d+(\.\d+)?\b/g,
            comment: /#.*$/gm,
            operator: /[+\-*/%=<>!&|~^]/g,
            punctuation: /[\[\](){}:.,;]/g,
        };

        function highlightSyntax() {
            if (currentState.mode !== 'python') return;
            
            const text = editor.innerText;
            const selection = window.getSelection();
            const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            
            let start = 0, end = 0;
            if(range) {
                const preSelectionRange = range.cloneRange();
                preSelectionRange.selectNodeContents(editor);
                preSelectionRange.setEnd(range.startContainer, range.startOffset);
                start = preSelectionRange.toString().length;
                end = start + range.toString().length;
            }

            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            for (const [tokenType, pattern] of Object.entries(pythonPatterns)) {
                 html = html.replace(pattern, (match) => {
                    if (html.substring(html.lastIndexOf('<'), html.indexOf(match)).includes('>')) {
                         return match;
                    }
                    if(tokenType === 'function' && new RegExp(`def\\s+${match}`).test(text)) {
                         return `<span class="token-function">${match}</span>`;
                    }
                     return `<span class="token-${tokenType}">${match}</span>`;
                 });
            }
            html = html.replace(/<span class="token-function">(\b(if|for|while|in|print)\b)<\/span>/g, '<span class="token-keyword">$1</span>');
            
            editor.innerHTML = html;
            restoreSelection(start, end);
        }

        function validatePythonCode() {
            if (currentState.mode !== 'python') return;
            const text = editor.innerText;
            const stack = [];
            const map = { "(": ")", "[": "]", "{": "}" };
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '(' || char === '[' || char === '{') {
                    stack.push(char);
                } else if (char === ')' || char === ']' || char === '}') {
                    const lastOpen = stack.pop();
                    if (map[lastOpen] !== char) {
                        statusText.textContent = `오류: 괄호 짝이 맞지 않습니다. '${lastOpen}'에 대한 닫는 괄호가 필요합니다.`;
                        return;
                    }
                }
            }
            if (stack.length > 0) {
                statusText.textContent = `오류: 괄호 짝이 맞지 않습니다. '${stack[stack.length - 1]}'가 닫히지 않았습니다.`;
            } else {
                statusText.textContent = "Python: 구문 이상 없음 (기본 검사)";
            }
        }
        
        function restoreSelection(absoluteCharIndex, endCharIndex) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            const range = document.createRange();
            let charIndex = 0, nodeStack = [editor], node, foundStart = false, stop = false;
            range.setStart(editor, 0);
            range.collapse(true);
            while (!stop && (node = nodeStack.pop())) {
                if (node.nodeType == 3) {
                    const nextCharIndex = charIndex + node.length;
                    if (!foundStart && absoluteCharIndex >= charIndex && absoluteCharIndex <= nextCharIndex) {
                        range.setStart(node, absoluteCharIndex - charIndex);
                        foundStart = true;
                    }
                    if (foundStart && endCharIndex >= charIndex && endCharIndex <= nextCharIndex) {
                        range.setEnd(node, endCharIndex - charIndex);
                        stop = true;
                    }
                    charIndex = nextCharIndex;
                } else {
                    let i = node.childNodes.length;
                    while (i--) {
                        nodeStack.push(node.childNodes[i]);
                    }
                }
            }
            sel.addRange(range);
        }

        // --- 이벤트 리스너 ---
        memoTab.addEventListener('click', () => switchMode('memo'));
        pythonTab.addEventListener('click', () => switchMode('python'));
        runButton.addEventListener('click', runPythonCode);
        closeConsoleBtn.addEventListener('click', closeConsole);

        let inputTimeout;
        editor.addEventListener('input', () => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(() => {
                if (currentState.mode === 'python') {
                    highlightSyntax();
                    validatePythonCode();
                }
                updateURL();
            }, 300);
        });

        window.addEventListener('DOMContentLoaded', loadFromURL);
    </script>
</body>
</html>

