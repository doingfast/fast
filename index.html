<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IDE - ë©”ëª¨ & íŒŒì´ì¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* VS Codeì™€ ìœ ì‚¬í•œ í…Œë§ˆ ë° í°íŠ¸ ì„¤ì • */
        body {
            font-family: 'Fira Code', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        /* contenteditable ì˜ì—­ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .editor-area {
            caret-color: #d4d4d4;
            white-space: pre-wrap;
            word-wrap: break-word;
            outline: none;
            line-height: 1.5;
            tab-size: 4;
            -moz-tab-size: 4;
        }
        /* contenteditable placeholder */
        .editor-area:empty::before {
            content: attr(data-placeholder);
            color: #6a6a6a;
            pointer-events: none;
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Python Syntax Highlighting Classes */
        .token-keyword { color: #c586c0; }
        .token-function { color: #dcdcaa; }
        .token-string { color: #ce9178; }
        .token-number { color: #b5cea8; }
        .token-comment { color: #6a9955; }
        .token-operator { color: #d4d4d4; }
        .token-punctuation { color: #d4d4d4; }
        .token-default { color: #9cdcfe; }

        /* í™œì„± íƒ­ ìŠ¤íƒ€ì¼ */
        .tab.active {
            background-color: #3f3f46;
            border-bottom: 2px solid #007acc;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header / Tab area -->
    <header class="bg-[#252526] flex-shrink-0">
        <div class="flex items-center border-t border-t-[#3f3f46]">
            <button id="memo-tab" class="tab px-4 py-2 text-sm focus:outline-none">
                ğŸ“ memo.txt
            </button>
            <button id="python-tab" class="tab px-4 py-2 text-sm focus:outline-none">
                ğŸ script.py
            </button>
            <button id="run-button" class="hidden ml-auto mr-4 px-3 py-1 text-sm bg-green-600 hover:bg-green-700 rounded focus:outline-none text-white">
                ì‹¤í–‰ â–¶
            </button>
        </div>
    </header>

    <!-- Main Editor Area -->
    <main class="flex-grow bg-[#1e1e1e] p-4 overflow-auto">
        <div id="editor" 
             contenteditable="true" 
             spellcheck="false" 
             class="editor-area h-full w-full"
             data-placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...">
        </div>
    </main>

    <!-- Output Console -->
    <div id="output-console" class="hidden flex-shrink-0 border-t-2 border-[#007acc]">
        <div class="bg-[#252526] px-4 py-1 flex justify-between items-center text-sm">
            <span>ì¶œë ¥</span>
            <button id="close-console-btn" class="text-xs hover:text-white text-gray-400">âœ–</button>
        </div>
        <pre id="output-text" class="p-4 text-sm whitespace-pre-wrap h-40 overflow-y-auto bg-[#1e1e1e]"></pre>
    </div>


    <!-- Footer / Status Bar -->
    <footer class="bg-[#007acc] text-white flex-shrink-0 px-4 py-1 text-sm flex justify-between items-center">
        <div>
            <span id="status-text">ì¤€ë¹„ ì™„ë£Œ</span>
        </div>
        <div>
            <span>Ln 1, Col 1</span> <!-- ì´ ë¶€ë¶„ì€ ê¸°ëŠ¥ êµ¬í˜„ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤. -->
        </div>
    </footer>

    <script>
        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const memoTab = document.getElementById('memo-tab');
        const pythonTab = document.getElementById('python-tab');
        const editor = document.getElementById('editor');
        const statusText = document.getElementById('status-text');
        const runButton = document.getElementById('run-button');
        const outputConsole = document.getElementById('output-console');
        const outputText = document.getElementById('output-text');
        const closeConsoleBtn = document.getElementById('close-console-btn');

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ
        let currentState = {
            mode: 'memo', // 'memo' or 'python'
            content: ''
        };
        
        // --- URL ì²˜ë¦¬ ---
        function updateURL() {
            try {
                const text = editor.innerText;
                const base64 = btoa(unescape(encodeURIComponent(text)));
                const hashContent = `mode=${currentState.mode}&data=${base64}`;
                if (window.location.hash !== '#' + hashContent) {
                   window.location.hash = hashContent;
                }
                currentState.content = text;
            } catch (e) {
                console.error("URL ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
                statusText.textContent = "ì˜¤ë¥˜: ë‚´ìš©ì„ URLì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const mode = params.get('mode') || 'memo';
            const data = params.get('data');

            switchMode(mode, false);

            if (data) {
                try {
                    const decodedText = decodeURIComponent(escape(atob(data)));
                    editor.innerText = decodedText;
                    currentState.content = decodedText;
                    if(currentState.mode === 'python') {
                        highlightSyntax();
                        validatePythonCode();
                    }
                } catch (e) {
                    console.error("URLì—ì„œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
                    editor.innerText = "URLì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                }
            }
        }

        // --- ëª¨ë“œ ì „í™˜ ---
        function switchMode(newMode, shouldUpdateURL = true) {
            currentState.mode = newMode;
            if (newMode === 'memo') {
                memoTab.classList.add('active');
                pythonTab.classList.remove('active');
                editor.dataset.placeholder = 'ê°„ë‹¨í•œ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”...';
                editor.innerHTML = editor.innerText;
                statusText.textContent = "ë©”ëª¨ ëª¨ë“œ";
                runButton.classList.add('hidden');
                closeConsole();
            } else { // python mode
                pythonTab.classList.add('active');
                memoTab.classList.remove('active');
                editor.dataset.placeholder = 'Python ì½”ë“œë¥¼ ì‘ì„±í•˜ì„¸ìš”...\n\n# ì˜ˆì‹œ ì½”ë“œ\nprint("ì•ˆë…•í•˜ì„¸ìš”! Web IDEì…ë‹ˆë‹¤.")\nfor i in range(5):\n    print(f"{i+1}ë²ˆì§¸ ì¶œë ¥ì…ë‹ˆë‹¤.")';
                runButton.classList.remove('hidden');
                highlightSyntax();
                validatePythonCode();
            }
            if (shouldUpdateURL) {
                updateURL();
            }
        }

        // --- Python ì½”ë“œ ì‹¤í–‰ ---
        function runPythonCode() {
            outputConsole.classList.remove('hidden');
            const code = editor.innerText;
            let capturedOutput = '';

            const originalConsoleLog = console.log;
            console.log = (...args) => {
                capturedOutput += args.join(' ') + '\n';
            };
            
            // Pythonì˜ print()ë¥¼ JavaScriptì˜ console.log()ë¡œ ë³€í™˜í•˜ì—¬ ì‹¤í–‰ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
            const jsCode = code.replace(/print\s*\((.*?)\)/g, 'console.log($1)');

            try {
                new Function(jsCode)();
                outputText.textContent = capturedOutput || '(ì¶œë ¥ ì—†ìŒ)';
            } catch (e) {
                outputText.textContent = `ì‹¤í–‰ ì˜¤ë¥˜:\n${e}`;
            } finally {
                console.log = originalConsoleLog; // ì›ë˜ console.logë¡œ ë³µì›
            }
        }
        
        function closeConsole() {
            outputConsole.classList.add('hidden');
        }

        // --- Python ì½”ë“œ í•˜ì´ë¼ì´íŒ… ë° ìœ íš¨ì„± ê²€ì‚¬ ---
        const pythonPatterns = {
            keyword: /\b(def|return|if|else|elif|for|while|import|from|class|try|except|finally|with|as|and|or|not|in|is|lambda|pass|break|continue|global|nonlocal|yield|assert|del|True|False|None)\b/g,
            function: /\b([a-zA-Z_][a-zA-Z0-9_]*)(?=\s*\()/g,
            string: /('[^']*'|"[^"]*"|f'[^']*'|f"[^"]*")/g,
            number: /\b\d+(\.\d+)?\b/g,
            comment: /#.*$/gm,
            operator: /[+\-*/%=<>!&|~^]/g,
            punctuation: /[\[\](){}:.,;]/g,
        };

        function highlightSyntax() {
            if (currentState.mode !== 'python') return;
            
            const text = editor.innerText;
            const selection = window.getSelection();
            const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
            
            let start = 0, end = 0;
            if(range) {
                const preSelectionRange = range.cloneRange();
                preSelectionRange.selectNodeContents(editor);
                preSelectionRange.setEnd(range.startContainer, range.startOffset);
                start = preSelectionRange.toString().length;
                end = start + range.toString().length;
            }

            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            for (const [tokenType, pattern] of Object.entries(pythonPatterns)) {
                 html = html.replace(pattern, (match) => {
                    if (html.substring(html.lastIndexOf('<'), html.indexOf(match)).includes('>')) {
                         return match;
                    }
                    if(tokenType === 'function' && new RegExp(`def\\s+${match}`).test(text)) {
                         return `<span class="token-function">${match}</span>`;
                    }
                     return `<span class="token-${tokenType}">${match}</span>`;
                 });
            }
            html = html.replace(/<span class="token-function">(\b(if|for|while|in|print)\b)<\/span>/g, '<span class="token-keyword">$1</span>');
            
            editor.innerHTML = html;
            restoreSelection(start, end);
        }

        function validatePythonCode() {
            if (currentState.mode !== 'python') return;
            const text = editor.innerText;
            const stack = [];
            const map = { "(": ")", "[": "]", "{": "}" };
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '(' || char === '[' || char === '{') {
                    stack.push(char);
                } else if (char === ')' || char === ']' || char === '}') {
                    const lastOpen = stack.pop();
                    if (map[lastOpen] !== char) {
                        statusText.textContent = `ì˜¤ë¥˜: ê´„í˜¸ ì§ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. '${lastOpen}'ì— ëŒ€í•œ ë‹«ëŠ” ê´„í˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.`;
                        return;
                    }
                }
            }
            if (stack.length > 0) {
                statusText.textContent = `ì˜¤ë¥˜: ê´„í˜¸ ì§ì´ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤. '${stack[stack.length - 1]}'ê°€ ë‹«íˆì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
            } else {
                statusText.textContent = "Python: êµ¬ë¬¸ ì´ìƒ ì—†ìŒ (ê¸°ë³¸ ê²€ì‚¬)";
            }
        }
        
        function restoreSelection(absoluteCharIndex, endCharIndex) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            const range = document.createRange();
            let charIndex = 0, nodeStack = [editor], node, foundStart = false, stop = false;
            range.setStart(editor, 0);
            range.collapse(true);
            while (!stop && (node = nodeStack.pop())) {
                if (node.nodeType == 3) {
                    const nextCharIndex = charIndex + node.length;
                    if (!foundStart && absoluteCharIndex >= charIndex && absoluteCharIndex <= nextCharIndex) {
                        range.setStart(node, absoluteCharIndex - charIndex);
                        foundStart = true;
                    }
                    if (foundStart && endCharIndex >= charIndex && endCharIndex <= nextCharIndex) {
                        range.setEnd(node, endCharIndex - charIndex);
                        stop = true;
                    }
                    charIndex = nextCharIndex;
                } else {
                    let i = node.childNodes.length;
                    while (i--) {
                        nodeStack.push(node.childNodes[i]);
                    }
                }
            }
            sel.addRange(range);
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        memoTab.addEventListener('click', () => switchMode('memo'));
        pythonTab.addEventListener('click', () => switchMode('python'));
        runButton.addEventListener('click', runPythonCode);
        closeConsoleBtn.addEventListener('click', closeConsole);

        let inputTimeout;
        editor.addEventListener('input', () => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(() => {
                if (currentState.mode === 'python') {
                    highlightSyntax();
                    validatePythonCode();
                }
                updateURL();
            }, 300);
        });

        window.addEventListener('DOMContentLoaded', loadFromURL);
    </script>
</body>
</html>

